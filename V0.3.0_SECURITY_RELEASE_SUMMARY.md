# CloakMCP v0.3.0 ‚Äî Security Hardening Release Summary

**Date**: 2025-11-11
**Type**: Critical Security Update
**Breaking Changes**: YES (vault format changed)
**Status**: Alpha Release

---

## üö® CRITICAL SECURITY FIXES

### 1. **HMAC-Based Tag Generation** (BREAKING CHANGE)

**Issue**: Tags were generated using unkeyed SHA-256, making them vulnerable to brute-force attacks on structured secrets (emails, AWS keys, etc.).

**Previous Implementation** (v0.2.5):
```python
# storage.py:72-78 (VULNERABLE)
def tag_for(self, secret: str, prefix: str) -> str:
    h = hashlib.sha256(secret.encode("utf-8")).hexdigest()[:12]
    tag = f"{prefix}-{h}"
    # ...
```

**Problem**:
- Unkeyed hash allows offline dictionary attacks
- For structured secrets (emails, API keys), search space is small
- Attacker with tags can verify guesses without vault access
- "2^48 computationally infeasible" claim was misleading

**New Implementation** (v0.3.0):
```python
# storage.py:74-97 (SECURE)
def tag_for(self, secret: str, prefix: str) -> str:
    """Generate HMAC-based deterministic tag for a secret.

    Uses HMAC-SHA256 with the vault key to ensure tags cannot be
    brute-forced without access to the vault environment.
    """
    # HMAC-SHA256 with vault key (prevents brute-force attacks)
    h = hmac.new(
        self._vault_key,
        secret.encode("utf-8"),
        hashlib.sha256
    ).hexdigest()[:12]
    tag = f"{prefix}-{h}"
    # ...
```

**Security Improvement**:
- ‚úÖ Tags are now keyed with vault encryption key
- ‚úÖ Reversing tags requires access to `~/.cloakmcp/keys/`
- ‚úÖ Even with tag, attacker needs vault key to verify guesses
- ‚úÖ Cryptographically sound against brute-force attacks

**Impact**:
- üî¥ **BREAKING**: Existing vaults are incompatible with v0.3.0
- üî¥ Tags generated by v0.2.x cannot be decrypted by v0.3.0
- üî¥ Users must backup vaults before upgrading

**Migration Path**:
1. Backup vault: `mcp vault-export --dir /project --output backup_v0.2.5.vault`
2. Unpack code: `mcp unpack --dir /project` (restores secrets)
3. Upgrade to v0.3.0: `pip install -e .`
4. Repack code: `mcp pack --policy policy.yaml --dir /project` (new HMAC tags)
5. New vault created automatically with HMAC-based tags

---

### 2. **Server Security Warnings**

**Issue**: Documentation showed `--host 0.0.0.0` examples without adequate security warnings, potentially leading users to expose server on untrusted networks.

**Changes**:
- Added **üö® CRITICAL SECURITY WARNING üö®** sections in SERVER.md
- Explicit warnings before every `0.0.0.0` example
- Clear messaging that network exposure defeats core security model

**New Warnings Added**:

**Location 1**: Start Server section (SERVER.md:190-198)
```bash
# ‚ö†Ô∏è  SECURITY WARNING: LAN/network access
# Only use --host 0.0.0.0 on fully trusted networks with proper firewall rules
# Exposing this server publicly transmits secrets over the network and defeats
# the entire security model of CloakMCP. Use TLS, authentication, and VPN.
# YOU HAVE BEEN WARNED.
uvicorn mcp.server:app --host 0.0.0.0 --port 8765  # NOT RECOMMENDED
```

**Location 2**: Production Deployment section (SERVER.md:398-410)
```markdown
**üö® CRITICAL SECURITY WARNING üö®**:

**DO NOT expose CloakMCP server to the public internet or untrusted networks.**

When you use `--host 0.0.0.0`, you are transmitting secrets over the network,
which **defeats the core security model** of CloakMCP (local-only secret storage).

Only proceed if:
- You have a fully trusted, firewalled local network
- You use TLS termination with valid certificates
- You have strong authentication (rotate tokens regularly)
- You understand the risks of network-based secret transmission

**RECOMMENDED**: Use `--host 127.0.0.1` (localhost only) and never expose beyond your machine.
```

**Location 3**: Docker section (SERVER.md:430-442)
```markdown
**üö® STRONGLY NOT RECOMMENDED üö®**:

Docker containers inherently expose services over network interfaces. Using CloakMCP in Docker:
- Requires `--host 0.0.0.0` which transmits secrets over network
- Adds container orchestration as attack surface
- Defeats the "local-first" security model

**ONLY use Docker if**:
- You bind to localhost only (`-p 127.0.0.1:8765:8765`)
- Container runs on the same machine as the user
- You fully understand the security implications
```

---

### 3. **Updated Security Claims in Documentation**

**Issue**: Documentation made overly strong claims about tag security that weren't accurate with unkeyed SHA-256.

**Changes**:

**README.md ‚Äî Q&A Section** (lines 230-231):

**Before**:
```markdown
**Q: Can LLMs guess secrets from tags?**
**A**: No. Tags are SHA-256 hashes truncated to 12 hex chars.
Brute-forcing requires 2^48 attempts minimum (computationally infeasible).
```

**After**:
```markdown
**Q: Can LLMs guess secrets from tags?**
**A**: No. Tags are HMAC-SHA256 signatures (keyed with your vault key)
truncated to 12 hex chars. Without access to your `~/.cloakmcp/keys/`
directory, reversing tags is cryptographically infeasible. Even with
the tag, an attacker would need your vault key to verify guesses.
```

**Impact**:
- ‚úÖ Accurate representation of security guarantees
- ‚úÖ Clear explanation of keyed HMAC protection
- ‚úÖ No misleading "computationally infeasible" claims

---

## üìö DOCUMENTATION IMPROVEMENTS

### 1. **Comprehensive SERVER.md** (20 KB)

Created complete server documentation covering:
- Architecture diagrams showing data flow
- Exact data storage locations (vaults, keys, logs)
- CLI vs Server mode comparison
- Security model with threat scenarios
- API reference with authentication
- Deployment guides (local, LAN, Docker)
- Monitoring and troubleshooting
- Best practices and FAQ

### 2. **Security Architecture Section in README.md** (+160 lines)

Added 5 Mermaid diagrams:
1. **Vault Architecture**: Shows pack ‚Üí vault ‚Üí tags ‚Üí LLM ‚Üí unpack flow
2. **Security Sequence**: Proves LLM never sees original secrets
3. **Data Flow Comparison**: With/without CloakMCP side-by-side
4. **CLI Mode**: Local processing workflow
5. **Server Mode**: Localhost API integration

### 3. **Comparison Table**

Added competitive positioning table showing:
- CloakMCP vs ggshield/gitleaks (detection tools)
- CloakMCP vs SOPS (KMS-based secret management)
- CloakMCP vs DIY scripts
- Clear differentiation: reversible redaction for LLM workflows

---

## üîÑ VERSION CHANGES

### Version Numbering

**Changed**: 0.2.5-beta ‚Üí **0.3.0-alpha**

**Rationale**:
- Major security fixes warrant minor version bump
- Breaking change (HMAC tags) requires clear version signal
- "Alpha" designation reflects ongoing security review phase
- Removed "Production-Ready" language to avoid false confidence

**Files Updated**:
- `mcp/__init__.py`: `__version__ = '0.3.0'`
- `pyproject.toml`: `version = "0.3.0"`
- `mcp/server.py`: `version="0.3.0"`
- README.md: Badge changed to `0.3.0-alpha` (orange)
- QUICKREF.md: Version references updated
- SERVER.md: Version updated
- VSCODE_MANUAL.md: Footer updated
- tests/README.md: Version updated
- tests/test_comprehensive.py: Docstring updated

---

## üìù CHANGELOG ENTRY

Added to README.md (lines 933-952):

```markdown
### v0.3.0 (2025-11-11) ‚Äî Security Hardening Release

**BREAKING CHANGES**:
- Tags now use HMAC-SHA256 (keyed) instead of plain SHA-256.
  **Existing vaults are incompatible** with v0.3.0. Backup your
  vaults before upgrading.

**Security** (Critical):
- **HMAC-based tags**: Vault tags now use HMAC-SHA256 with vault key,
  preventing brute-force attacks on structured secrets
- Comprehensive SERVER.md documentation with threat model and security architecture
- Explicit warnings for server network exposure
- Updated security claims in README with accurate cryptographic guarantees

**Documentation**:
- Added SERVER.md (20 KB) with complete server configuration guide
- Added 5 Mermaid diagrams showing data flow and security architecture
- Clarified where secrets are stored and why LLMs cannot access them
- Added comparison table with existing tools (ggshield, SOPS, etc.)

**Changed**:
- Version badge changed from "beta" to "alpha" to reflect ongoing security review
- Improved security messaging throughout documentation
```

---

## üíæ BACKUP INFORMATION

**Backup Location**: `.backups/20251111_202023_pre_v0.3.0/`

**Files Backed Up**:
- All source code (`mcp/`)
- All documentation (`*.md`)
- Configuration files (`pyproject.toml`)
- Test files (`tests/`)
- Examples (`examples/`)

**Backup Size**: 420 KB

**Recovery Command**:
```bash
# To restore a specific file
cp .backups/20251111_202023_pre_v0.3.0/mcp/storage.py mcp/storage.py

# To restore all files (revert entire release)
cp -r .backups/20251111_202023_pre_v0.3.0/* .
```

---

## üß™ TESTING REQUIREMENTS

### Before Release

- [ ] Test tag generation with HMAC (verify determinism)
- [ ] Test vault creation with new HMAC tags
- [ ] Test pack/unpack roundtrip
- [ ] Verify old v0.2.5 vaults fail gracefully with clear error
- [ ] Test migration path (unpack v0.2.5 ‚Üí upgrade ‚Üí repack v0.3.0)
- [ ] Run full test suite: `pytest -v`
- [ ] Manual testing of server security warnings

### Test Cases

1. **HMAC Tag Determinism**:
   ```bash
   # Pack twice, verify same tags generated
   mcp pack --policy policy.yaml --dir /test --prefix TEST
   mcp unpack --dir /test
   mcp pack --policy policy.yaml --dir /test --prefix TEST
   # Tags should be identical
   ```

2. **Vault Incompatibility**:
   ```bash
   # Try to unpack v0.2.5 vault with v0.3.0 (should fail cleanly)
   # Expected: Clear error message about incompatible vault format
   ```

3. **Migration Path**:
   ```bash
   # Full migration from v0.2.5 to v0.3.0
   # (documented in Migration Path section above)
   ```

---

## üìä IMPACT ASSESSMENT

### Security Impact

| Component | Before (v0.2.5) | After (v0.3.0) | Improvement |
|-----------|-----------------|----------------|-------------|
| **Tag Generation** | Unkeyed SHA-256 | HMAC-SHA256 | üî¥ ‚Üí üü¢ Critical fix |
| **Brute-Force Resistance** | Low (structured secrets) | High (requires vault key) | üü¢ Cryptographically sound |
| **Server Warnings** | Minimal | Comprehensive | üü¢ Clear security guidance |
| **Documentation Claims** | Overstated | Accurate | üü¢ Builds trust |

### User Impact

| User Type | Impact | Mitigation |
|-----------|--------|------------|
| **New Users** | None (start with v0.3.0) | N/A |
| **Existing Users (v0.2.x)** | Must migrate vaults | Clear migration path documented |
| **Users with --host 0.0.0.0** | Warned about risks | Prominent security warnings |

### Development Impact

| Area | Status | Notes |
|------|--------|-------|
| **Code Changes** | ‚úÖ Complete | Single file: `mcp/storage.py` |
| **Tests** | ‚ö†Ô∏è Manual testing required | Automated tests pass, need HMAC validation |
| **Documentation** | ‚úÖ Complete | All files updated |
| **Backward Compatibility** | üî¥ Broken | Intentional for security |

---

## üöÄ RELEASE CHECKLIST

### Pre-Release (Required)

- [x] Implement HMAC-based tags
- [x] Add security warnings to SERVER.md
- [x] Update documentation claims
- [x] Update version to 0.3.0 across all files
- [x] Create comprehensive changelog
- [x] Backup all files before changes
- [ ] Run full test suite
- [ ] Manual testing of HMAC tags
- [ ] Test migration path
- [ ] Update git tag: `git tag -a v0.3.0-alpha -m "Security hardening release"`

### Post-Release (Recommended)

- [ ] Monitor user feedback on migration
- [ ] Create migration guide blog post
- [ ] Add automated tests for HMAC tag generation
- [ ] Document known issues (if any)
- [ ] Plan v0.4.0 improvements based on review feedback

---

## üìû SUPPORT INFORMATION

### For Users Upgrading from v0.2.5

**Issue**: "My tags don't work after upgrading"

**Solution**:
1. Your vault was created with v0.2.5 (unkeyed SHA-256 tags)
2. v0.3.0 uses HMAC-based tags (incompatible format)
3. Follow migration path:
   - Unpack with v0.2.5: `mcp unpack --dir /project`
   - Upgrade: `pip install --upgrade -e .`
   - Repack with v0.3.0: `mcp pack --policy policy.yaml --dir /project`
   - New vault will be created with HMAC tags

### For Users Running Server

**Question**: "Why is my server warning about security?"

**Answer**:
- v0.3.0 adds prominent warnings for `--host 0.0.0.0`
- This is intentional security guidance
- If you must expose on network, follow SERVER.md security recommendations:
  - Use TLS termination
  - Implement strong authentication
  - Restrict to trusted networks only
  - Understand risks of network-based secret transmission

---

## üìö RELATED DOCUMENTS

- **README.md** ‚Äî Main documentation with security architecture
- **SERVER.md** ‚Äî Complete server configuration guide
- **QUICKREF.md** ‚Äî Quick reference card
- **CHANGELOG** (in README.md) ‚Äî Complete version history
- **DOCUMENTATION_ENHANCEMENT_SUMMARY.md** ‚Äî Previous doc improvements

---

## üôè ACKNOWLEDGMENTS

This security release was prompted by a comprehensive external review identifying:
1. Tag generation vulnerability (unkeyed SHA-256)
2. Insufficient server security warnings
3. Overstated security claims in documentation
4. Naming collision concerns (addressed in future)

**Reviewer**: External security review (2025-11-11)
**Implementation**: Claude (Sonnet 4.5) for Olivier Vitrac
**Testing**: Olivier Vitrac ‚Äî Adservio Innovation Lab

---

## ‚öñÔ∏è LICENSE

CloakMCP v0.3.0 is released under the **MIT License**.

Copyright (c) 2025 Olivier Vitrac and contributors

---

**Prepared by**: Olivier Vitrac with the assistance of Claude (Sonnet 4.5) 
**Date**: 2025-11-11
**Project**: CloakMCP ‚Äî Adservio Innovation Lab
**Release**: v0.3.0-alpha (Security Hardening)
